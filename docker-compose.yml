# Docker Compose Example for dagster-authkit
# Production-ready setup with SQLite backend and admin bootstrapping

version: '3.8'

services:
  dagster:
    image: dagster-authkit:latest
    build:
      context: .
      dockerfile: Dockerfile
    
    ports:
      - "3000:3000"
    
    environment:
      # Backend configuration
      - DAGSTER_AUTH_BACKEND=sqlite
      - DAGSTER_AUTH_DB=/data/dagster_auth.db
      
      # Admin Bootstrap (Infrastructure as Code)
      # These ENV vars automatically create/reset admin user on startup
      - DAGSTER_AUTH_ADMIN_USER=admin
      - DAGSTER_AUTH_ADMIN_PASSWORD=${ADMIN_PASSWORD:-ChangeMe123!}
      - DAGSTER_AUTH_ADMIN_EMAIL=admin@company.com
      
      # Session security
      - DAGSTER_AUTH_SECRET_KEY=${SECRET_KEY:-please-change-me-in-production}
      - DAGSTER_AUTH_COOKIE_SECURE=true  # Enable in production with HTTPS
      - DAGSTER_AUTH_SESSION_MAX_AGE=86400  # 24 hours
      
      # Rate limiting
      - DAGSTER_AUTH_RATE_LIMIT=true
      - DAGSTER_AUTH_RATE_LIMIT_ATTEMPTS=5
      - DAGSTER_AUTH_RATE_LIMIT_WINDOW=300
      
      # Audit logging
      - DAGSTER_AUTH_AUDIT_LOG=true
      - DAGSTER_AUTH_LOG_LEVEL=INFO
      
      # Dagster configuration
      - DAGSTER_HOME=/opt/dagster/home
    
    volumes:
      # Persist authentication database
      - dagster-auth-data:/data
      
      # Persist Dagster data
      - dagster-home:/opt/dagster/home
      
      # Mount your Dagster code
      - ./my-dagster-project:/workspace
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/auth/login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  dagster-auth-data:
    driver: local
  dagster-home:
    driver: local

# Usage:
# ------
# 1. Create .env file:
#    echo "SECRET_KEY=$(openssl rand -hex 32)" > .env
#    echo "ADMIN_PASSWORD=YourSecurePassword123" >> .env
#
# 2. Build and run:
#    docker-compose up -d
#
# 3. Access:
#    http://localhost:3000
#    Login: admin / YourSecurePassword123
#
# 4. View logs:
#    docker-compose logs -f dagster
#
# 5. Manage users:
#    docker-compose exec dagster dagster-authkit list-users
#    docker-compose exec dagster dagster-authkit add-user newuser --editor