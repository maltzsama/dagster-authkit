# ========================================
# Dagster AuthKit - PostgreSQL
# ========================================

.PHONY: help up down logs restart shell shell-db clean test-health open init-db

help:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë      Dagster AuthKit - PostgreSQL Backend              ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "Quick Commands:"
	@echo "  make up              - Start PostgreSQL + Redis + Dagster"
	@echo "  make down            - Stop all containers"
	@echo "  make logs            - Show logs (follow mode)"
	@echo "  make restart         - Restart everything"
	@echo ""
	@echo "Utilities:"
	@echo "  make shell           - Bash in Dagster container"
	@echo "  make shell-db        - psql shell in PostgreSQL"
	@echo "  make init-db         - Initialize database & admin"
	@echo "  make test-health     - Test health endpoint"
	@echo "  make open            - Open Dagster UI"
	@echo "  make clean           - Remove ALL data (DB + volumes)"
	@echo ""

init-db:
	@echo "üîß Initializing database..."
	@docker-compose exec dagster dagster-authkit init-db --with-admin
	@echo "‚úÖ Database initialized"

up:
	@echo "üöÄ Starting PostgreSQL environment..."
	@docker-compose up -d --build
	@echo ""
	@echo "‚è≥ Waiting for services..."
	@sleep 8
	@echo ""
	@echo "üîß Initializing database..."
	@$(MAKE) init-db 2>/dev/null || echo "‚ö†Ô∏è  Database might already exist"
	@echo ""
	@echo "‚úÖ PostgreSQL Environment Ready!"
	@echo ""
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "  üåê Dagster UI:   http://localhost:3000"
	@echo "  üóÑÔ∏è  PostgreSQL:   localhost:5432"
	@echo "  üíæ Redis:        localhost:6379"
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo ""
	@echo "üí° Tip: Run 'make shell-db' to access PostgreSQL"
	@echo ""

down:
	@echo "üõë Stopping all containers and removing volumes..."
	@docker-compose down -v
	@echo "‚úÖ Environment cleaned (volumes removed)"

logs:
	@docker-compose logs -f dagster

restart:
	@$(MAKE) down
	@sleep 2
	@$(MAKE) up

shell:
	@echo "üêö Opening bash in Dagster container..."
	@docker-compose exec dagster bash

shell-db:
	@echo "üóÑÔ∏è  Opening psql shell..."
	@docker-compose exec postgres psql -U dagster_user -d dagster_auth

test-health:
	@echo "üè• Testing health endpoint..."
	@curl -s http://localhost:3000/auth/health | python -m json.tool

open:
	@command -v open >/dev/null 2>&1 && open http://localhost:3000 || \
	 command -v xdg-open >/dev/null 2>&1 && xdg-open http://localhost:3000 || \
	 echo "Open manually: http://localhost:3000"

clean:
	@echo "‚ö†Ô∏è  WARNING: This will DELETE all PostgreSQL data!"
	@read -p "Are you sure? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo ""
	@echo "üóëÔ∏è  Stopping containers and removing volumes..."
	@docker-compose down -v
	@echo "‚úÖ All data removed!"