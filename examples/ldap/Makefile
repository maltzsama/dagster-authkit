# ========================================
# Dagster AuthKit - LDAP Test Environment
# ========================================

.PHONY: help up down logs restart shell clean test-ldap test-health open ldap-admin

help:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë       Dagster AuthKit - LDAP Test Environment          ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "Quick Commands:"
	@echo "  make up              - Start LDAP + Dagster + Redis"
	@echo "  make down            - Stop all containers"
	@echo "  make logs            - Show all logs (follow mode)"
	@echo "  make restart         - Restart everything"
	@echo ""
	@echo "Testing:"
	@echo "  make test-ldap       - Test LDAP connection"
	@echo "  make test-health     - Test Dagster health"
	@echo "  make ldap-admin      - Open LDAP Admin UI"
	@echo "  make open            - Open Dagster UI"
	@echo ""
	@echo "Utilities:"
	@echo "  make shell           - Bash in Dagster container"
	@echo "  make shell-ldap      - Bash in LDAP container"
	@echo "  make logs-dagster    - Dagster logs only"
	@echo "  make logs-ldap       - LDAP logs only"
	@echo "  make clean           - Remove ALL data & volumes"
	@echo ""
	@echo "Users:"
	@echo "  make show-users      - Show test LDAP users"
	@echo ""

seed-ldap:
	@echo "üå± Seeding LDAP with test data..."
	@docker cp ldap-bootstrap.ldif authkit_openldap:/tmp/bootstrap.ldif
	@docker exec authkit_openldap ldapadd \
		-x -H ldap://localhost \
		-D "cn=admin,dc=example,dc=com" \
		-w admin_secret \
		-f /tmp/bootstrap.ldif
	@echo "‚úÖ LDAP seeded with test users!"

up:
	@echo "üöÄ Starting LDAP test environment..."
	@docker-compose up -d --build
	@echo ""
	@echo "‚è≥ Waiting for LDAP to initialize..."
	@sleep 10
	@echo ""
	@echo "üå± Seeding LDAP data..."
	@$(MAKE) seed-ldap 2>/dev/null || echo "‚ö†Ô∏è  LDAP seed failed (might already exist)"
	@echo ""
	@echo "‚úÖ LDAP Environment Ready!"
	@echo ""
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "  üåê Dagster UI:    http://localhost:3000"
	@echo "  üîß LDAP Admin UI: http://localhost:8080"
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo ""
	@echo "üë• Test Users:"
	@echo "  alice/password123     ‚Üí ADMIN"
	@echo "  bob/password123       ‚Üí EDITOR"
	@echo "  charlie/password123   ‚Üí LAUNCHER"
	@echo "  dave/password123      ‚Üí VIEWER"
	@echo ""
	@echo "üí° Tip: Run 'make test-ldap' to verify LDAP connection"
	@echo "üí° Tip: Run 'make ldap-admin' to manage LDAP users"
	@echo ""

down:
	@echo "üõë Stopping all containers and removing volumes..."
	@docker-compose down -v
	@echo "‚úÖ Environment cleaned (volumes removed)"

restart:
	@echo "üîÑ Performing a fresh restart..."
	@$(MAKE) down
	@sleep 2
	@$(MAKE) up

logs:
	@docker-compose logs -f

logs-dagster:
	@docker-compose logs -f dagster

logs-ldap:
	@docker-compose logs -f ldap

shell:
	@echo "üêö Opening bash in Dagster container..."
	@docker-compose exec dagster bash

shell-ldap:
	@echo "üêö Opening bash in LDAP container..."
	@docker-compose exec ldap bash

test-ldap:
	@echo "üîç Testing LDAP connection..."
	@echo ""
	@docker-compose exec ldap ldapsearch \
		-x -H ldap://localhost \
		-D "cn=admin,dc=example,dc=com" \
		-w admin_secret \
		-b "dc=example,dc=com" \
		"(objectClass=*)" dn | grep "^dn:" || echo "‚ùå LDAP test failed"
	@echo ""
	@echo "‚úÖ LDAP connection working!"

test-health:
	@echo "üè• Testing Dagster health endpoint..."
	@echo ""
	@curl -s http://localhost:3000/auth/health | python -m json.tool || echo "‚ùå Health check failed"

ldap-admin:
	@echo "üîß Opening LDAP Admin UI..."
	@echo ""
	@echo "URL:      http://localhost:8080"
	@echo "Login DN: cn=admin,dc=example,dc=com"
	@echo "Password: admin_secret"
	@echo ""
	@command -v open >/dev/null 2>&1 && open http://localhost:8080 || \
	 command -v xdg-open >/dev/null 2>&1 && xdg-open http://localhost:8080 || \
	 echo "‚ùå Could not open browser automatically"

open:
	@echo "üåê Opening Dagster UI..."
	@command -v open >/dev/null 2>&1 && open http://localhost:3000 || \
	 command -v xdg-open >/dev/null 2>&1 && xdg-open http://localhost:3000 || \
	 echo "‚ùå Could not open browser. Go to: http://localhost:3000"

show-users:
	@echo "üë• LDAP Test Users:"
	@echo ""
	@docker-compose exec ldap ldapsearch \
		-x -LLL -H ldap://localhost \
		-D "cn=admin,dc=example,dc=com" \
		-w admin_secret \
		-b "ou=users,dc=example,dc=com" \
		"(objectClass=inetOrgPerson)" uid cn mail displayName | \
		grep -E "^(dn:|uid:|cn:|mail:|displayName:)" || echo "‚ùå Could not fetch users"

clean:
	@echo "‚ö†Ô∏è  WARNING: This will DELETE all LDAP data and volumes!"
	@read -p "Are you sure? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo ""
	@echo "üóëÔ∏è  Stopping containers and removing volumes..."
	@docker-compose down -v
	@echo "‚úÖ All data removed!"

# ========================================
# Advanced: User Management
# ========================================

add-user:
	@echo "‚ûï Adding LDAP user..."
	@echo "This is a placeholder - edit ldap-bootstrap.ldif and restart"
	@echo "Or use LDAP Admin UI: make ldap-admin"

inspect-groups:
	@echo "üë• LDAP Groups:"
	@echo ""
	@docker-compose exec ldap ldapsearch \
		-x -LLL -H ldap://localhost \
		-D "cn=admin,dc=example,dc=com" \
		-w admin_secret \
		-b "ou=groups,dc=example,dc=com" \
		"(objectClass=groupOfNames)" cn member | \
		grep -E "^(dn:|cn:|member:)"