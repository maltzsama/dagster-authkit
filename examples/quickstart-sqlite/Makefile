# ========================================
# Dagster AuthKit - SQLite Quickstart
# ========================================

.PHONY: help up down logs restart shell clean test-health test-login open

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘      Dagster AuthKit - SQLite Quickstart               â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Quick Commands:"
	@echo "  make up              - Start Dagster (SQLite backend)"
	@echo "  make down            - Stop containers"
	@echo "  make logs            - Show logs (follow mode)"
	@echo "  make restart         - Restart everything"
	@echo ""
	@echo "Utilities:"
	@echo "  make shell           - Open bash in container"
	@echo "  make test-health     - Test health endpoint"
	@echo "  make test-login      - Test login page"
	@echo "  make open            - Open browser to Dagster UI"
	@echo "  make clean           - Remove ALL data (SQLite DB)"
	@echo ""

up:
	@echo "ğŸš€ Starting SQLite Quickstart..."
	@docker-compose up -d
	@echo ""
	@echo "â³ Waiting for Dagster to initialize..."
	@sleep 8
	@echo ""
	@echo "âœ… Dagster AuthKit is running!"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  ğŸŒ URL:    http://localhost:3000"
	@echo "  ğŸ‘¤ User:   admin"
	@echo "  ğŸ”‘ Pass:   (check logs above for auto-generated password)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ’¡ Tip: Run 'make logs' to see startup logs"
	@echo "ğŸ’¡ Tip: Run 'make open' to open browser"
	@echo ""

down:
	@echo "ğŸ›‘ Stopping containers..."
	@docker-compose down
	@echo "âœ… Stopped"

logs:
	@docker-compose logs -f dagster

restart:
	@echo "ğŸ”„ Restarting..."
	@$(MAKE) down
	@sleep 2
	@$(MAKE) up

shell:
	@echo "ğŸš Opening bash shell..."
	@docker-compose exec dagster bash

test-health:
	@echo "ğŸ¥ Testing health endpoint..."
	@echo ""
	@curl -s http://localhost:3000/auth/health | python -m json.tool || echo "âŒ Health check failed"

test-login:
	@echo "ğŸ§ª Testing login page..."
	@echo ""
	@curl -sI http://localhost:3000/auth/login | head -n 1

open:
	@echo "ğŸŒ Opening browser..."
	@command -v open >/dev/null 2>&1 && open http://localhost:3000 || \
	 command -v xdg-open >/dev/null 2>&1 && xdg-open http://localhost:3000 || \
	 echo "âŒ Could not detect browser. Open manually: http://localhost:3000"

clean:
	@echo "âš ï¸  WARNING: This will DELETE the SQLite database!"
	@read -p "Are you sure? [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo ""
	@echo "ğŸ—‘ï¸  Stopping containers and removing volumes..."
	@docker-compose down -v
	@echo "ğŸ—‘ï¸  Removing local database file..."
	@rm -f dagster_auth.db
	@echo "âœ… All data removed!"